<!-- public/index.html -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stripe Transactions Viewer</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .transaction-card {
        margin-bottom: 15px;
        transition: all 0.3s ease;
      }
      .transaction-card:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }
      .tab-content {
        padding: 20px 0;
      }
      .loading {
        text-align: center;
        padding: 50px;
      }
      .timestamp {
        font-size: 0.8rem;
        color: #6c757d;
      }
      .badge {
        margin-left: 5px;
      }
      .empty-state {
        text-align: center;
        padding: 50px;
        color: #6c757d;
      }
    </style>
  </head>
  <body>
    <div class="container my-5">
      <h1 class="mb-4">Stripe Transactions Viewer</h1>

      <ul class="nav nav-tabs" id="transactionTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="balance-tab"
            data-bs-toggle="tab"
            data-bs-target="#balance"
            type="button"
            role="tab"
            aria-controls="balance"
            aria-selected="true"
          >
            Balance Transactions
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="charges-tab"
            data-bs-toggle="tab"
            data-bs-target="#charges"
            type="button"
            role="tab"
            aria-controls="charges"
            aria-selected="false"
          >
            Charges
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="payouts-tab"
            data-bs-toggle="tab"
            data-bs-target="#payouts"
            type="button"
            role="tab"
            aria-controls="payouts"
            aria-selected="false"
          >
            Payouts
          </button>
        </li>
      </ul>

      <div class="tab-content" id="transactionTabsContent">
        <div class="tab-pane fade show active" id="balance" role="tabpanel" aria-labelledby="balance-tab">
          <div id="balanceTransactions">
            <div class="loading">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading transactions...</p>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="charges" role="tabpanel" aria-labelledby="charges-tab">
          <div id="chargesTransactions">
            <div class="loading">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading charges...</p>
            </div>
          </div>
        </div>

        <div class="tab-pane fade" id="payouts" role="tabpanel" aria-labelledby="payouts-tab">
          <div id="payoutsTransactions">
            <div class="loading">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Loading payouts...</p>
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex justify-content-center mt-4">
        <button id="refreshBtn" class="btn btn-primary">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            fill="currentColor"
            class="bi bi-arrow-clockwise"
            viewBox="0 0 16 16"
          >
            <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z" />
            <path
              d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"
            />
          </svg>
          Refresh Data
        </button>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Load transactions on page load
        loadTransactions();

        // Refresh button click handler
        document.getElementById("refreshBtn").addEventListener("click", loadTransactions);

        function loadTransactions() {
          // Reset loading states
          document.getElementById("balanceTransactions").innerHTML =
            createLoadingHTML("Loading transactions...");
          document.getElementById("chargesTransactions").innerHTML = createLoadingHTML("Loading charges...");
          document.getElementById("payoutsTransactions").innerHTML = createLoadingHTML("Loading payouts...");

          // Fetch transaction data from our API
          fetch("/api/transactions")
            .then((response) => {
              if (!response.ok) {
                throw new Error(`HTTP error! Status: ${response.status}`);
              }
              return response.json();
            })
            .then((data) => {
              displayTransactions(data);
            })
            .catch((error) => {
              console.error("Error fetching transactions:", error);
              displayError(error.message);
            });
        }

        function displayTransactions(data) {
          // Display balance transactions
          if (data.balanceTransactions && data.balanceTransactions.length > 0) {
            let balanceHTML = '<div class="row">';
            data.balanceTransactions.forEach((transaction) => {
              balanceHTML += createBalanceTransactionCard(transaction);
            });
            balanceHTML += "</div>";
            document.getElementById("balanceTransactions").innerHTML = balanceHTML;
          } else {
            document.getElementById("balanceTransactions").innerHTML = createEmptyState(
              "No balance transactions found"
            );
          }

          // Display charges
          if (data.charges && data.charges.length > 0) {
            let chargesHTML = '<div class="row">';
            data.charges.forEach((charge) => {
              chargesHTML += createChargeCard(charge);
            });
            chargesHTML += "</div>";
            document.getElementById("chargesTransactions").innerHTML = chargesHTML;

            // After rendering, fetch customer details for cards that need it
            setTimeout(() => {
              const chargeCards = document.querySelectorAll("#chargesTransactions .card[data-customer-id]");
              chargeCards.forEach((card) => {
                const customerId = card.getAttribute("data-customer-id");
                if (customerId) {
                  fetchCustomerDetails(customerId, card);
                }
              });
            }, 100);
          } else {
            document.getElementById("chargesTransactions").innerHTML = createEmptyState("No charges found");
          }

          // Display payouts
          if (data.payouts && data.payouts.length > 0) {
            let payoutsHTML = '<div class="row">';
            data.payouts.forEach((payout) => {
              payoutsHTML += createPayoutCard(payout);
            });
            payoutsHTML += "</div>";
            document.getElementById("payoutsTransactions").innerHTML = payoutsHTML;
          } else {
            document.getElementById("payoutsTransactions").innerHTML = createEmptyState("No payouts found");
          }
        }

        function createBalanceTransactionCard(transaction) {
          const date = new Date(transaction.created * 1000).toLocaleString();
          const amount = (transaction.amount / 100).toFixed(2);
          const currency = transaction.currency.toUpperCase();

          // Add classes for all transaction types
          let typeClass = "secondary";
          if (transaction.type === "charge") typeClass = "success";
          if (transaction.type === "payout") typeClass = "primary";
          if (transaction.type === "refund") typeClass = "warning";
          if (transaction.type === "payment_refund") typeClass = "warning";
          if (transaction.type === "payment") typeClass = "info";
          if (transaction.type === "adjustment") typeClass = "dark";
          if (transaction.type === "dispute") typeClass = "danger";
          if (transaction.type === "reserve_transaction") typeClass = "light";
          if (transaction.type === "transfer") typeClass = "info";

          // Get status class
          let statusClass = "secondary";
          if (transaction.status === "available") statusClass = "success";
          if (transaction.status === "pending") statusClass = "warning";
          if (transaction.status === "canceled") statusClass = "danger";

          // Check for source information that might contain email
          let customerInfo = "";
          let customerEmail = "";

          // Try to extract customer email from various places
          if (transaction.source) {
            if (typeof transaction.source === "object") {
              // If source is expanded object
              if (
                transaction.source.customer &&
                transaction.source.customer.customer &&
                transaction.source.customer.customer.email
              ) {
                customerEmail = transaction.source.customer.customer.email;
              } else if (transaction.source.customer && transaction.source.customer.email) {
                customerEmail = transaction.source.customer.email;
              } else if (transaction.source.receipt_email) {
                customerEmail = transaction.source.receipt_email;
              } else if (transaction.source.email) {
                customerEmail = transaction.source.email;
              }
            } else if (typeof transaction.source === "string" && transaction.source.indexOf("@") > -1) {
              // If source is string with email
              customerEmail = transaction.source;
            }
          }

          // If we found an email
          if (customerEmail) {
            customerInfo = `<strong>Customer:</strong> ${customerEmail}<br>`;
          }

          return `
          <div class="col-md-6 col-lg-4">
            <div class="card transaction-card">
              <div class="card-body">
                <h5 class="card-title d-flex justify-content-between">
                  ${amount} ${currency}
                  <span class="badge bg-${typeClass}">${transaction.type}</span>
                </h5>
                <h6 class="card-subtitle mb-2 text-muted">ID: ${transaction.id}</h6>
                <p class="card-text">
                  <strong>Status:</strong> <span class="badge bg-${statusClass}">${transaction.status}</span><br>
                  ${customerInfo}
                  <strong>Description:</strong> ${transaction.description || "N/A"}<br>
                  <strong>Available on:</strong> ${new Date(
                    transaction.available_on * 1000
                  ).toLocaleDateString()}
                </p>
                <div class="timestamp">
                  Created: ${date}
                </div>
              </div>
            </div>
          </div>
        `;
        }

        // Fetch customer details if needed
        function fetchCustomerDetails(customerId, cardElement) {
          if (!customerId) return;

          fetch(`/api/customer/${customerId}`)
            .then((response) => response.json())
            .then((customer) => {
              if (customer && customer.email) {
                const emailElement = cardElement.querySelector(".customer-email");
                if (emailElement) {
                  emailElement.textContent = customer.email;
                  emailElement.parentElement.classList.remove("d-none");
                }
              }
            })
            .catch((error) => console.error("Error fetching customer details:", error));
        }

        function createChargeCard(charge) {
          const date = new Date(charge.created * 1000).toLocaleString();
          const amount = (charge.amount / 100).toFixed(2);
          const currency = charge.currency.toUpperCase();

          // Enhanced status class handling to include all possible statuses
          let statusClass = "secondary";
          if (charge.status === "succeeded") statusClass = "success";
          if (charge.status === "failed") statusClass = "danger";
          if (charge.status === "pending") statusClass = "warning";
          if (charge.status === "canceled") statusClass = "danger";
          if (charge.status === "on_hold") statusClass = "warning";
          if (charge.status === "refunded") statusClass = "info";
          if (charge.status === "partially_refunded") statusClass = "info";
          if (charge.status === "disputed") statusClass = "danger";

          // Customer information
          let customerInfo = "";
          let customerEmail = "Unknown";

          if (charge.customer) {
            // Try different paths to find the customer email
            if (charge.customer.customer && charge.customer.customer.email) {
              // Path from your data structure: charge.customer.customer.email
              customerEmail = charge.customer.customer.email;
            } else if (typeof charge.customer === "object" && charge.customer.email) {
              // Standard path: charge.customer.email
              customerEmail = charge.customer.email;
            } else if (typeof charge.customer === "string") {
              // If we just have a customer ID
              customerEmail = "Loading..."; // Will be fetched later
            }
          }

          // Add receipt email if available
          if (charge.receipt_email && customerEmail === "Unknown") {
            customerEmail = charge.receipt_email;
          }

          // Add payment method details
          let paymentMethodDetails = "N/A";
          if (charge.payment_method_details) {
            paymentMethodDetails = charge.payment_method_details.type || "N/A";
            if (charge.payment_method_details.card) {
              const card = charge.payment_method_details.card;
              paymentMethodDetails = `${card.brand} •••• ${card.last4}`;
            }
          }

          const cardHTML = `
          <div class="col-md-6 col-lg-4">
            <div class="card transaction-card" data-customer-id="${
              typeof charge.customer === "string" ? charge.customer : ""
            }">
              <div class="card-body">
                <h5 class="card-title d-flex justify-content-between">
                  ${amount} ${currency}
                  <span class="badge bg-${statusClass}">${charge.status}</span>
                </h5>
                <h6 class="card-subtitle mb-2 text-muted">ID: ${charge.id}</h6>
                <p class="card-text">
                  <strong>Payment Method:</strong> ${paymentMethodDetails}<br>
                  <strong>Description:</strong> ${charge.description || "N/A"}<br>
                  <div class="${customerEmail === "Unknown" ? "d-none" : ""}">
                    <strong>Customer Email:</strong> <span class="customer-email">${customerEmail}</span><br>
                  </div>
                  <strong>Receipt:</strong> ${
                    charge.receipt_url
                      ? '<a href="' + charge.receipt_url + '" target="_blank">View Receipt</a>'
                      : "N/A"
                  }
                </p>
                <div class="timestamp">
                  Created: ${date}
                </div>
              </div>
            </div>
          </div>
        `;

          return cardHTML;
        }

        function createPayoutCard(payout) {
          const date = new Date(payout.created * 1000).toLocaleString();
          const amount = (payout.amount / 100).toFixed(2);
          const currency = payout.currency.toUpperCase();

          let statusClass = "secondary";
          if (payout.status === "paid") statusClass = "success";
          if (payout.status === "failed") statusClass = "danger";
          if (payout.status === "pending") statusClass = "warning";

          return `
          <div class="col-md-6 col-lg-4">
            <div class="card transaction-card">
              <div class="card-body">
                <h5 class="card-title d-flex justify-content-between">
                  ${amount} ${currency}
                  <span class="badge bg-${statusClass}">${payout.status}</span>
                </h5>
                <h6 class="card-subtitle mb-2 text-muted">ID: ${payout.id}</h6>
                <p class="card-text">
                  <strong>Method:</strong> ${payout.method}<br>
                  <strong>Type:</strong> ${payout.type}<br>
                  <strong>Arrival Date:</strong> ${new Date(payout.arrival_date * 1000).toLocaleDateString()}
                </p>
                <div class="timestamp">
                  Created: ${date}
                </div>
              </div>
            </div>
          </div>
        `;
        }

        function createLoadingHTML(message) {
          return `
          <div class="loading">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">${message}</p>
          </div>
        `;
        }

        function createEmptyState(message) {
          return `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" class="bi bi-inbox" viewBox="0 0 16 16">
              <path d="M4.98 4a.5.5 0 0 0-.39.188L1.54 8H6a.5.5 0 0 1 .5.5 1.5 1.5 0 1 0 3 0A.5.5 0 0 1 10 8h4.46l-3.05-3.812A.5.5 0 0 0 11.02 4H4.98zm-1.17-.437A1.5 1.5 0 0 1 4.98 3h6.04a1.5 1.5 0 0 1 1.17.563l3.7 4.625a.5.5 0 0 1 .106.374l-.39 3.124A1.5 1.5 0 0 1 14.117 13H1.883a1.5 1.5 0 0 1-1.489-1.314l-.39-3.124a.5.5 0 0 1 .106-.374l3.7-4.625z"/>
            </svg>
            <h4 class="mt-3">${message}</h4>
          </div>
        `;
        }

        function displayError(message) {
          const errorHTML = `
          <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">Error!</h4>
            <p>${message}</p>
            <hr>
            <p class="mb-0">Please check your API keys and try again.</p>
          </div>
        `;

          document.getElementById("balanceTransactions").innerHTML = errorHTML;
          document.getElementById("chargesTransactions").innerHTML = errorHTML;
          document.getElementById("payoutsTransactions").innerHTML = errorHTML;
        }
      });
    </script>
  </body>
</html>
